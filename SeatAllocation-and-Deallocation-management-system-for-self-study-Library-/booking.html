<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Your Seat - New Drishti Library</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/booking.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Dashboard Layout -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-book-open"></i>
                    <h2>New <span>Drishti</span></h2>
                </div>
            </div>
            <div class="sidebar-menu">
                <ul>
                    <li>
                        <a href="student-dashboard.html">
                            <i class="fas fa-home"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="booking.html">
                            <i class="fas fa-calendar-plus"></i>
                            <span>Book Seat</span>
                        </a>
                    </li>
                    <li>
                        <a href="booking-history.html">
                            <i class="fas fa-history"></i>
                            <span>Booking History</span>
                        </a>
                    </li>
                    <li>
                        <a href="profile.html">
                            <i class="fas fa-user"></i>
                            <span>Profile</span>
                        </a>
                    </li>
                    <li>
                        <a href="payments.html">
                            <i class="fas fa-wallet"></i>
                            <span>Payments</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <h1>Book Your Study Seat</h1>
                    <span class="current-date" id="currentDate"></span>
                </div>
                <div class="top-bar-right">
                    <div class="user-menu">
                        <div class="user-info">
                            <div class="user-avatar">
                                <img id="userAvatar" src="" alt="User">
                            </div>
                            <div class="user-details">
                                <span class="user-name" id="userName">Student</span>
                                <span class="user-role">Student</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Booking Content -->
            <div class="booking-content">
                <div class="booking-steps">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">Select Date & Time</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">Choose Seat</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-label">Confirm & Pay</div>
                    </div>
                </div>

                <!-- Step 1: Date & Time Selection -->
                <div class="booking-step active" id="step1">
                    <div class="step-header">
                        <h2>Select Date & Time Slot</h2>
                        <p>Choose when you want to study at the library</p>
                    </div>

                    <div class="time-selection-container">
                        <div class="date-selection">
                            <h3>Select Date</h3>
                            <div class="calendar-container">
                                <input type="date" id="bookingDate" class="date-picker" min="">
                            </div>
                            <div class="date-info">
                                <p id="selectedDateInfo">Please select a date to view available slots</p>
                            </div>
                        </div>

                        <div class="time-slots-selection">
                            <h3>Available Time Slots</h3>
                            <div class="slots-info">
                                <span id="availableSlotsCount">Loading available slots...</span>
                            </div>
                            <div class="time-slots-grid" id="timeSlotsGrid">
                                <!-- Time slots will be populated by JavaScript -->
                                <div class="loading-slots">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading available time slots...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="step-actions">
                        <button class="btn-next" id="nextToStep2" disabled>
                            Next: Choose Seat
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Seat Selection -->
                <div class="booking-step" id="step2">
                    <div class="step-header">
                        <h2>Choose Your Study Seat</h2>
                        <p>Select an available seat from the library layout</p>
                    </div>

                    <div class="seat-selection-container">
                        <div class="library-layout">
                            <div class="layout-header">
                                <h3>Library Layout - Floor 1</h3>
                                <div class="layout-info">
                                    <span>Total Seats: 170</span>
                                    <span id="availableSeatsCount">Available: Loading...</span>
                                    <span id="selectedSeatInfo">Selected: None</span>
                                </div>
                            </div>

                            <div class="seats-grid" id="seatsGrid">
                                <!-- Seats will be populated by JavaScript -->
                                <div class="loading-seats">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading seat layout...</p>
                                </div>
                            </div>

                            <div class="layout-legend">
                                <div class="legend-item">
                                    <div class="seat-sample available"></div>
                                    <span>Available</span>
                                </div>
                                <div class="legend-item">
                                    <div class="seat-sample selected"></div>
                                    <span>Selected</span>
                                </div>
                                <div class="legend-item">
                                    <div class="seat-sample booked"></div>
                                    <span>Booked</span>
                                </div>
                                <div class="legend-item">
                                    <div class="seat-sample reserved"></div>
                                    <span>Reserved</span>
                                </div>
                                <div class="legend-item">
                                    <div class="seat-sample premium"></div>
                                    <span>Premium</span>
                                </div>
                            </div>
                        </div>

                        <div class="seat-details">
                            <h3>Seat Information</h3>
                            <div class="seat-info-card" id="seatInfoCard">
                                <div class="no-seat-selected">
                                    <i class="fas fa-chair"></i>
                                    <p>Select a seat to view details</p>
                                </div>
                                <div class="seat-details-content" style="display: none;">
                                    <div class="seat-number" id="selectedSeatNumber"></div>
                                    <div class="seat-type" id="selectedSeatType"></div>
                                    <div class="seat-features">
                                        <h4>Features:</h4>
                                        <ul id="seatFeaturesList">
                                            <!-- Features will be populated by JavaScript -->
                                        </ul>
                                    </div>
                                    <div class="seat-location">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span id="seatLocation"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="step-actions">
                        <button class="btn-prev" id="prevToStep1">
                            <i class="fas fa-arrow-left"></i>
                            Previous
                        </button>
                        <button class="btn-next" id="nextToStep3" disabled>
                            Next: Confirm & Pay
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Confirmation & Payment -->
                <div class="booking-step" id="step3">
                    <div class="step-header">
                        <h2>Confirm Your Booking</h2>
                        <p>Review your booking details and proceed to payment</p>
                    </div>

                    <div class="confirmation-container">
                        <div class="booking-summary-card">
                            <h3>Booking Summary</h3>
                            <div class="summary-details">
                                <div class="summary-item">
                                    <span class="label">Date:</span>
                                    <span class="value" id="summaryDate"></span>
                                </div>
                                <div class="summary-item">
                                    <span class="label">Time Slot:</span>
                                    <span class="value" id="summaryTimeSlot"></span>
                                </div>
                                <div class="summary-item">
                                    <span class="label">Seat Number:</span>
                                    <span class="value" id="summarySeatNumber"></span>
                                </div>
                                <div class="summary-item">
                                    <span class="label">Seat Type:</span>
                                    <span class="value" id="summarySeatType"></span>
                                </div>
                                <div class="summary-item">
                                    <span class="label">Duration:</span>
                                    <span class="value" id="summaryDuration"></span>
                                </div>
                                <div class="summary-item total">
                                    <span class="label">Total Amount:</span>
                                    <span class="value" id="summaryAmount"></span>
                                </div>
                            </div>
                        </div>

                        <div class="payment-section">
                            <h3>Payment Method</h3>
                            <div class="payment-methods">
                                <div class="payment-method selected" data-method="wallet">
                                    <div class="method-icon">
                                        <i class="fas fa-wallet"></i>
                                    </div>
                                    <div class="method-info">
                                        <h4>Wallet</h4>
                                        <p>Pay using wallet balance</p>
                                    </div>
                                    <div class="method-check">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>

                                <div class="payment-method" data-method="upi">
                                    <div class="method-icon">
                                        <i class="fas fa-mobile-alt"></i>
                                    </div>
                                    <div class="method-info">
                                        <h4>UPI Payment</h4>
                                        <p>Pay using UPI apps</p>
                                    </div>
                                    <div class="method-check">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>

                                <div class="payment-method" data-method="card">
                                    <div class="method-icon">
                                        <i class="fas fa-credit-card"></i>
                                    </div>
                                    <div class="method-info">
                                        <h4>Credit/Debit Card</h4>
                                        <p>Pay using card</p>
                                    </div>
                                    <div class="method-check">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Wallet Payment Form -->
                            <div class="payment-form active" id="walletForm">
                                <div class="wallet-balance">
                                    <span>Available Balance:</span>
                                    <strong id="walletBalance">₹0</strong>
                                </div>
                                <div class="payment-amount">
                                    <span>Booking Amount:</span>
                                    <strong id="bookingAmount">₹0</strong>
                                </div>
                                <div class="balance-after">
                                    <span>Balance After Payment:</span>
                                    <strong id="balanceAfter">₹0</strong>
                                </div>
                                <button class="btn-pay-wallet" id="payWithWallet">
                                    <i class="fas fa-wallet"></i>
                                    Pay from Wallet
                                </button>
                                <p class="wallet-note" id="walletNote" style="display: none;">Insufficient balance in wallet</p>
                            </div>

                            <!-- UPI Payment Form -->
                            <div class="payment-form" id="upiForm">
                                <div class="form-group">
                                    <label for="upiId">UPI ID</label>
                                    <input type="text" id="upiId" class="form-control" placeholder="yourname@upi">
                                </div>
                                <button class="btn-pay-upi" id="payWithUPI">
                                    <i class="fas fa-bolt"></i>
                                    Pay Now with UPI
                                </button>
                            </div>

                            <!-- Card Payment Form -->
                            <div class="payment-form" id="cardForm">
                                <div class="form-group">
                                    <label for="cardNumber">Card Number</label>
                                    <input type="text" id="cardNumber" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="expiryDate">Expiry Date</label>
                                        <input type="text" id="expiryDate" class="form-control" placeholder="MM/YY" maxlength="5">
                                    </div>
                                    <div class="form-group">
                                        <label for="cvv">CVV</label>
                                        <input type="text" id="cvv" class="form-control" placeholder="123" maxlength="3">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="cardHolder">Card Holder Name</label>
                                    <input type="text" id="cardHolder" class="form-control" placeholder="John Doe">
                                </div>
                                <button class="btn-pay-card" id="payWithCard">
                                    <i class="fas fa-credit-card"></i>
                                    Pay with Card
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="step-actions">
                        <button class="btn-prev" id="prevToStep2">
                            <i class="fas fa-arrow-left"></i>
                            Previous
                        </button>
                        <button class="btn-confirm" id="confirmBooking">
                            <i class="fas fa-lock"></i>
                            Confirm & Pay
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p id="loadingText">Processing your booking...</p>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText"></span>
    </div>

    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjKGiYrqK1TlBi0N4aFHEi2WNZdnPy3s8",
            authDomain: "library-7abcc-f1a9d.firebaseapp.com",
            projectId: "library-7abcc-f1a9d",
            storageBucket: "library-7abcc-f1a9d.firebasestorage.app",
            messagingSenderId: "861023989601",
            appId: "1:861023989601:web:795656dddb6e0795f05f20"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Initialize Firebase services
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Firebase collections
        const firebaseCollections = {
            USERS: "users",
            BOOKINGS: "bookings",
            SEATS: "seats",
            PAYMENTS: "payments",
            TIME_SLOTS: "timeSlots"
        };

        // Enable offline persistence
        db.enablePersistence()
          .catch((err) => {
              console.log("Firebase persistence error: ", err);
          });

        // Make globally available
        window.firebase = firebase;
        window.auth = auth;
        window.db = db;
        window.storage = storage;
        window.firebaseCollections = firebaseCollections;

        console.log("Firebase initialized successfully");
    </script>

    <!-- Booking JavaScript -->
    <script>
        // Global variables
        let currentUser = null;
        let userData = null;
        let timeSlots = [];
        let allSeats = [];
        let availableSeats = [];
        let selectedDate = null;
        let selectedTimeSlot = null;
        let selectedSeat = null;
        let userWalletBalance = 0;
        let bookingAmount = 0;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Booking page loaded');
            initializeBooking();
            setupEventListeners();
            loadTimeSlots();
            loadAllSeats();
            setMinDate();
        });

        function initializeBooking() {
            // Check if user is logged in
            currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Update user info
            updateUserInfo();
            loadUserWalletBalance();
        }

        function setupEventListeners() {
            // Date picker change
            document.getElementById('bookingDate').addEventListener('change', function(e) {
                selectedDate = e.target.value;
                updateDateInfo();
                checkAvailableSlots();
            });

            // Step navigation
            document.getElementById('nextToStep2').addEventListener('click', goToStep2);
            document.getElementById('prevToStep1').addEventListener('click', goToStep1);
            document.getElementById('nextToStep3').addEventListener('click', goToStep3);
            document.getElementById('prevToStep2').addEventListener('click', goToStep2FromStep3);

            // Payment method selection
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    selectPaymentMethod(this.dataset.method);
                });
            });

            // Confirm booking
            document.getElementById('confirmBooking').addEventListener('click', confirmBooking);

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                logoutUser();
            });
        }

        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name || 'Student';
                if (currentUser.photoURL) {
                    document.getElementById('userAvatar').src = currentUser.photoURL;
                }
            }
        }

        function setMinDate() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const minDate = tomorrow.toISOString().split('T')[0];
            document.getElementById('bookingDate').min = minDate;
            
            // Set default date to tomorrow
            document.getElementById('bookingDate').value = minDate;
            selectedDate = minDate;
            updateDateInfo();
        }

        function updateDateInfo() {
            if (selectedDate) {
                const date = new Date(selectedDate);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const formattedDate = date.toLocaleDateString('en-IN', options);
                document.getElementById('selectedDateInfo').textContent = `Selected: ${formattedDate}`;
                document.getElementById('currentDate').textContent = formattedDate;
            }
        }

        async function loadTimeSlots() {
            try {
                const slotsSnapshot = await db.collection(firebaseCollections.TIME_SLOTS).get();
                timeSlots = [];
                
                slotsSnapshot.forEach(doc => {
                    const slot = doc.data();
                    slot.id = doc.id;
                    timeSlots.push(slot);
                });

                displayTimeSlots();
                checkAvailableSlots();

            } catch (error) {
                console.error('Error loading time slots:', error);
                showNotification('Error loading time slots', 'error');
            }
        }

        function displayTimeSlots() {
            const timeSlotsGrid = document.getElementById('timeSlotsGrid');
            
            if (timeSlots.length === 0) {
                timeSlotsGrid.innerHTML = `
                    <div class="no-slots">
                        <i class="fas fa-clock"></i>
                        <p>No time slots available</p>
                    </div>
                `;
                return;
            }

            let slotsHTML = '';
            timeSlots.forEach(slot => {
                if (slot.isActive) {
                    slotsHTML += `
                        <div class="time-slot-card" data-slot-id="${slot.id}" onclick="selectTimeSlot('${slot.id}')">
                            <div class="time-slot-name">${slot.name}</div>
                            <div class="time-slot-time">${slot.time}</div>
                            <div class="time-slot-price">₹${slot.price}</div>
                            <div class="time-slot-features">
                                ${slot.features ? slot.features.map(feature => `<li>${feature}</li>`).join('') : ''}
                            </div>
                            <div class="slot-availability" id="availability-${slot.id}">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>Checking availability...</span>
                            </div>
                        </div>
                    `;
                }
            });

            timeSlotsGrid.innerHTML = slotsHTML;
        }

        async function checkAvailableSlots() {
            if (!selectedDate) return;

            try {
                // Get bookings for selected date
                const selectedDateObj = new Date(selectedDate);
                const startOfDay = new Date(selectedDateObj);
                startOfDay.setHours(0, 0, 0, 0);
                
                const endOfDay = new Date(selectedDateObj);
                endOfDay.setHours(23, 59, 59, 999);

                const bookingsSnapshot = await db.collection(firebaseCollections.BOOKINGS)
                    .where('bookingDate', '>=', startOfDay)
                    .where('bookingDate', '<=', endOfDay)
                    .where('status', 'in', ['confirmed', 'pending'])
                    .get();

                const bookedSlots = {};
                bookingsSnapshot.forEach(doc => {
                    const booking = doc.data();
                    if (booking.slotType) {
                        bookedSlots[booking.slotType] = (bookedSlots[booking.slotType] || 0) + 1;
                    }
                });

                // Update availability for each slot
                timeSlots.forEach(slot => {
                    const availabilityElement = document.getElementById(`availability-${slot.id}`);
                    if (availabilityElement) {
                        const bookedCount = bookedSlots[slot.id] || 0;
                        const totalCapacity = getSlotCapacity(slot.id);
                        const availableCount = totalCapacity - bookedCount;

                        if (availableCount > 0) {
                            availabilityElement.innerHTML = `
                                <i class="fas fa-check-circle" style="color: #27ae60;"></i>
                                <span>${availableCount} seats available</span>
                            `;
                            availabilityElement.style.color = '#27ae60';
                        } else {
                            availabilityElement.innerHTML = `
                                <i class="fas fa-times-circle" style="color: #e74c3c;"></i>
                                <span>Fully booked</span>
                            `;
                            availabilityElement.style.color = '#e74c3c';
                        }
                    }
                });

                updateAvailableSlotsCount();

            } catch (error) {
                console.error('Error checking available slots:', error);
            }
        }

        function getSlotCapacity(slotId) {
            // Define capacity for each slot type
            const capacities = {
                'morning': 50,
                'evening': 50,
                'fullday': 30,
                'night': 20,
                '24hours': 20
            };
            return capacities[slotId] || 40;
        }

        function updateAvailableSlotsCount() {
            let availableCount = 0;
            timeSlots.forEach(slot => {
                if (slot.isActive) {
                    availableCount++;
                }
            });
            document.getElementById('availableSlotsCount').textContent = `${availableCount} slots available`;
        }

        function selectTimeSlot(slotId) {
            // Remove selection from all slots
            document.querySelectorAll('.time-slot-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Add selection to clicked slot
            const selectedCard = document.querySelector(`[data-slot-id="${slotId}"]`);
            selectedCard.classList.add('selected');

            selectedTimeSlot = timeSlots.find(slot => slot.id === slotId);
            
            // Enable next button
            document.getElementById('nextToStep2').disabled = false;

            showNotification(`Selected: ${selectedTimeSlot.name}`, 'success');
        }

        async function loadAllSeats() {
            try {
                const seatsSnapshot = await db.collection(firebaseCollections.SEATS).get();
                allSeats = [];
                
                seatsSnapshot.forEach(doc => {
                    const seat = doc.data();
                    seat.id = doc.id;
                    allSeats.push(seat);
                });

                displaySeats();

            } catch (error) {
                console.error('Error loading seats:', error);
                showNotification('Error loading seat layout', 'error');
            }
        }

        function displaySeats() {
            const seatsGrid = document.getElementById('seatsGrid');
            
            if (allSeats.length === 0) {
                seatsGrid.innerHTML = `
                    <div class="no-seats">
                        <i class="fas fa-chair"></i>
                        <p>No seats configured</p>
                    </div>
                `;
                return;
            }

            let seatsHTML = '';
            for (let i = 1; i <= 170; i++) {
                const seat = allSeats.find(s => s.seatNumber === i) || {
                    seatNumber: i,
                    type: 'standard',
                    isActive: true,
                    features: ['Standard Chair', 'Individual Table', 'Charging Port']
                };

                seatsHTML += `
                    <div class="seat ${seat.type} available" 
                         data-seat-number="${seat.seatNumber}"
                         data-seat-type="${seat.type}"
                         onclick="selectSeat(${seat.seatNumber})">
                        ${seat.seatNumber}
                    </div>
                `;
            }

            seatsGrid.innerHTML = seatsHTML;
            updateAvailableSeatsCount();
        }

        function updateAvailableSeatsCount() {
            const availableSeats = allSeats.filter(seat => seat.isActive).length;
            document.getElementById('availableSeatsCount').textContent = `Available: ${availableSeats}`;
        }

        function selectSeat(seatNumber) {
            const seat = allSeats.find(s => s.seatNumber === seatNumber);
            if (!seat || !seat.isActive) {
                showNotification('This seat is not available', 'error');
                return;
            }

            // Remove selection from all seats
            document.querySelectorAll('.seat').forEach(seatEl => {
                seatEl.classList.remove('selected');
            });

            // Add selection to clicked seat
            const selectedSeatEl = document.querySelector(`[data-seat-number="${seatNumber}"]`);
            selectedSeatEl.classList.add('selected');

            selectedSeat = seat;
            
            // Update seat info card
            updateSeatInfoCard(seat);
            
            // Enable next button
            document.getElementById('nextToStep3').disabled = false;
            
            // Update selected seat info
            document.getElementById('selectedSeatInfo').textContent = `Selected: Seat ${seatNumber}`;

            showNotification(`Selected Seat ${seatNumber}`, 'success');
        }

        function updateSeatInfoCard(seat) {
            const seatInfoCard = document.getElementById('seatInfoCard');
            const noSeatSelected = seatInfoCard.querySelector('.no-seat-selected');
            const seatDetailsContent = seatInfoCard.querySelector('.seat-details-content');

            noSeatSelected.style.display = 'none';
            seatDetailsContent.style.display = 'block';

            document.getElementById('selectedSeatNumber').textContent = `Seat ${seat.seatNumber}`;
            document.getElementById('selectedSeatType').textContent = seat.type.charAt(0).toUpperCase() + seat.type.slice(1);
            
            const featuresList = document.getElementById('seatFeaturesList');
            featuresList.innerHTML = '';
            seat.features.forEach(feature => {
                const li = document.createElement('li');
                li.textContent = feature;
                featuresList.appendChild(li);
            });

            document.getElementById('seatLocation').textContent = `Row ${seat.row}, Column ${seat.column}`;
            
            seatInfoCard.classList.add('has-selection');
        }

        // Step Navigation Functions
        function goToStep2() {
            if (!selectedTimeSlot) {
                showNotification('Please select a time slot', 'error');
                return;
            }

            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            
            // Update steps
            updateSteps(2);
            
            // Check seat availability for selected date and time
            checkSeatAvailability();
        }

        function goToStep1() {
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
            updateSteps(1);
        }

        function goToStep3() {
            if (!selectedSeat) {
                showNotification('Please select a seat', 'error');
                return;
            }

            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.add('active');
            updateSteps(3);
            
            // Update booking summary
            updateBookingSummary();
        }

        function goToStep2FromStep3() {
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            updateSteps(2);
        }

        function updateSteps(activeStep) {
            document.querySelectorAll('.step').forEach((step, index) => {
                if (index + 1 === activeStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
        }

        async function checkSeatAvailability() {
            if (!selectedDate || !selectedTimeSlot) return;

            try {
                const selectedDateObj = new Date(selectedDate);
                const bookingsSnapshot = await db.collection(firebaseCollections.BOOKINGS)
                    .where('bookingDate', '==', selectedDateObj)
                    .where('slotType', '==', selectedTimeSlot.id)
                    .where('status', 'in', ['confirmed', 'pending'])
                    .get();

                const bookedSeatNumbers = [];
                bookingsSnapshot.forEach(doc => {
                    const booking = doc.data();
                    if (booking.seatNumber) {
                        bookedSeatNumbers.push(booking.seatNumber);
                    }
                });

                // Update seat availability
                document.querySelectorAll('.seat').forEach(seatEl => {
                    const seatNumber = parseInt(seatEl.dataset.seatNumber);
                    
                    if (bookedSeatNumbers.includes(seatNumber)) {
                        seatEl.classList.remove('available', 'selected');
                        seatEl.classList.add('booked');
                        seatEl.onclick = null;
                    } else {
                        seatEl.classList.remove('booked');
                        seatEl.classList.add('available');
                        seatEl.onclick = function() { selectSeat(seatNumber); };
                    }
                });

                const availableCount = allSeats.length - bookedSeatNumbers.length;
                document.getElementById('availableSeatsCount').textContent = `Available: ${availableCount}`;

            } catch (error) {
                console.error('Error checking seat availability:', error);
            }
        }

        function updateBookingSummary() {
            if (!selectedDate || !selectedTimeSlot || !selectedSeat) return;

            // Format date
            const date = new Date(selectedDate);
            const formattedDate = date.toLocaleDateString('en-IN', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            document.getElementById('summaryDate').textContent = formattedDate;
            document.getElementById('summaryTimeSlot').textContent = `${selectedTimeSlot.name} (${selectedTimeSlot.time})`;
            document.getElementById('summarySeatNumber').textContent = selectedSeat.seatNumber;
            document.getElementById('summarySeatType').textContent = selectedSeat.type.charAt(0).toUpperCase() + selectedSeat.type.slice(1);
            document.getElementById('summaryDuration').textContent = selectedTimeSlot.duration;
            document.getElementById('summaryAmount').textContent = `₹${selectedTimeSlot.price}`;

            bookingAmount = selectedTimeSlot.price;
            updatePaymentSection();
        }

        async function loadUserWalletBalance() {
            try {
                const userDoc = await db.collection(firebaseCollections.USERS).doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                    userWalletBalance = userData.walletBalance || 0;
                    updatePaymentSection();
                }
            } catch (error) {
                console.error('Error loading wallet balance:', error);
            }
        }

        function updatePaymentSection() {
            document.getElementById('walletBalance').textContent = `₹${userWalletBalance}`;
            document.getElementById('bookingAmount').textContent = `₹${bookingAmount}`;
            
            const balanceAfter = userWalletBalance - bookingAmount;
            document.getElementById('balanceAfter').textContent = `₹${balanceAfter}`;

            const payWithWalletBtn = document.getElementById('payWithWallet');
            const walletNote = document.getElementById('walletNote');

            if (userWalletBalance >= bookingAmount) {
                payWithWalletBtn.disabled = false;
                walletNote.style.display = 'none';
            } else {
                payWithWalletBtn.disabled = true;
                walletNote.style.display = 'block';
            }
        }

        function selectPaymentMethod(method) {
            // Remove selection from all methods
            document.querySelectorAll('.payment-method').forEach(methodEl => {
                methodEl.classList.remove('selected');
            });

            // Add selection to clicked method
            document.querySelector(`[data-method="${method}"]`).classList.add('selected');

            // Show corresponding form
            document.querySelectorAll('.payment-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById(`${method}Form`).classList.add('active');
        }

        async function confirmBooking() {
            if (!selectedDate || !selectedTimeSlot || !selectedSeat) {
                showNotification('Please complete all booking details', 'error');
                return;
            }

            try {
                showLoading(true, 'Processing your booking...');

                // Check if seat is still available
                const selectedDateObj = new Date(selectedDate);
                const existingBooking = await db.collection(firebaseCollections.BOOKINGS)
                    .where('bookingDate', '==', selectedDateObj)
                    .where('slotType', '==', selectedTimeSlot.id)
                    .where('seatNumber', '==', selectedSeat.seatNumber)
                    .where('status', 'in', ['confirmed', 'pending'])
                    .get();

                if (!existingBooking.empty) {
                    showNotification('Sorry, this seat has been booked by someone else. Please select another seat.', 'error');
                    goToStep2();
                    return;
                }

                // Process payment based on selected method
                const paymentMethod = document.querySelector('.payment-method.selected').dataset.method;
                let paymentSuccessful = false;

                if (paymentMethod === 'wallet') {
                    paymentSuccessful = await processWalletPayment();
                } else {
                    // For UPI and Card, we'll simulate payment
                    paymentSuccessful = await simulatePayment(paymentMethod);
                }

                if (!paymentSuccessful) {
                    showNotification('Payment failed. Please try again.', 'error');
                    return;
                }

                // Create booking
                const bookingData = {
                    userId: currentUser.uid,
                    userName: currentUser.name,
                    userEmail: currentUser.email,
                    bookingDate: selectedDateObj,
                    slotType: selectedTimeSlot.id,
                    slotName: selectedTimeSlot.name,
                    timeSlot: selectedTimeSlot.time,
                    seatNumber: selectedSeat.seatNumber,
                    seatType: selectedSeat.type,
                    amount: selectedTimeSlot.price,
                    duration: selectedTimeSlot.duration,
                    paymentMethod: paymentMethod,
                    status: 'confirmed',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    paidAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection(firebaseCollections.BOOKINGS).add(bookingData);

                showLoading(false);
                showNotification('Booking confirmed successfully!', 'success');

                // Redirect to dashboard after 2 seconds
                setTimeout(() => {
                    window.location.href = 'student-dashboard.html';
                }, 2000);

            } catch (error) {
                console.error('Error confirming booking:', error);
                showLoading(false);
                showNotification('Error confirming booking. Please try again.', 'error');
            }
        }

        async function processWalletPayment() {
            if (userWalletBalance < bookingAmount) {
                showNotification('Insufficient wallet balance', 'error');
                return false;
            }

            try {
                // Update wallet balance
                const newBalance = userWalletBalance - bookingAmount;
                await db.collection(firebaseCollections.USERS).doc(currentUser.uid).update({
                    walletBalance: newBalance
                });

                // Record transaction
                await db.collection(firebaseCollections.TRANSACTIONS).add({
                    userId: currentUser.uid,
                    type: 'debit',
                    amount: bookingAmount,
                    description: `Booking payment for ${selectedTimeSlot.name}`,
                    paymentMethod: 'wallet',
                    status: 'success',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                userWalletBalance = newBalance;
                return true;

            } catch (error) {
                console.error('Error processing wallet payment:', error);
                return false;
            }
        }

        async function simulatePayment(method) {
            // Simulate payment processing
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Record transaction
            await db.collection(firebaseCollections.TRANSACTIONS).add({
                userId: currentUser.uid,
                type: 'debit',
                amount: bookingAmount,
                description: `Booking payment for ${selectedTimeSlot.name}`,
                paymentMethod: method,
                status: 'success',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            return true;
        }

        function logoutUser() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut().then(() => {
                    localStorage.removeItem('currentUser');
                    window.location.href = 'index.html';
                }).catch((error) => {
                    console.error('Logout error:', error);
                });
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = 'notification show';
            
            if (type === 'success') {
                notification.classList.add('success');
            } else if (type === 'error') {
                notification.classList.add('error');
            } else {
                notification.classList.remove('success', 'error');
            }
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        function showLoading(show, text = 'Processing...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            loadingText.textContent = text;
            
            if (show) {
                loadingOverlay.classList.add('active');
            } else {
                loadingOverlay.classList.remove('active');
            }
        }
    </script>
</body>
</html>